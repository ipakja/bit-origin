name: BIT Origin Deployment

on:
  # Nur manuell ausl√∂sbar - f√ºr lokale VMware-Umgebung
  workflow_dispatch:
    inputs:
      server_type:
        description: 'Server-Typ (vmware/production)'
        required: true
        default: 'vmware'
        type: choice
        options:
          - vmware
          - production

jobs:
  deploy:
    runs-on: ubuntu-latest
    # Nur ausf√ºhren, wenn Secrets vorhanden sind (optional - f√ºr lokale VM nicht erforderlich)
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup SSH
      uses: webfactory/ssh-agent@v0.7.0
      with:
        ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
    
    - name: Deploy to BIT Origin Server
      run: |
        echo "üñ•Ô∏è  Deployment zu ${{ inputs.server_type }} Server"
        ssh -o StrictHostKeyChecking=no -o ConnectTimeout=10 ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} '
          set -e
          cd /opt/bit-origin || exit 1
          echo "üîÑ Git Pull..."
          git pull origin main || exit 1
          
          echo "üîÑ Docker Compose Update..."
          if [ -f docker/docker-compose.yml ]; then
            cd docker
            docker compose pull || true
            docker compose up -d || true
            cd ..
          fi
          
          echo "‚úÖ Deployment abgeschlossen"
        '
      continue-on-error: true
    
    - name: Health Check
      if: always() && ${{ inputs.server_type == 'production' }}
      run: |
        echo "üîç Health Checks (Production)..."
        FAILED=0
        
        if curl -f -s --max-time 5 https://boksitsupport.ch > /dev/null 2>&1; then
          echo "‚úÖ Website: OK"
        else
          echo "‚ö†Ô∏è  Website: Nicht erreichbar"
          FAILED=1
        fi
        
        if curl -f -s --max-time 5 https://api.boksitsupport.ch/status > /dev/null 2>&1; then
          echo "‚úÖ API: OK"
        else
          echo "‚ö†Ô∏è  API: Nicht erreichbar (optional)"
        fi
        
        if curl -f -s --max-time 5 https://monitoring.boksitsupport.ch > /dev/null 2>&1; then
          echo "‚úÖ Monitoring: OK"
        else
          echo "‚ö†Ô∏è  Monitoring: Nicht erreichbar (optional)"
        fi
        
        if [ $FAILED -eq 1 ]; then
          echo "‚ö†Ô∏è  Einige Health Checks fehlgeschlagen, aber Deployment fortgesetzt"
        fi
      continue-on-error: true
    
    - name: VMware Local Health Check
      if: always() && ${{ inputs.server_type == 'vmware' }}
      run: |
        echo "üîç Health Checks (VMware - Lokal)..."
        echo "‚ÑπÔ∏è  F√ºr lokale VMware-VM (192.168.42.133) werden Health Checks √ºbersprungen"
        echo "‚ÑπÔ∏è  Lokale Services:"
        echo "   - Uptime-Kuma: http://192.168.42.133:3001"
        echo "   - Zammad: http://192.168.42.133:8080"
        echo "   - Nextcloud: http://192.168.42.133:8081-8100"
        echo "‚úÖ Deployment auf lokaler VM abgeschlossen"
      continue-on-error: true
    
    - name: Notify on Success
      if: success()
      run: |
        echo "‚úÖ BIT Origin Deployment erfolgreich!"
        if [ "${{ inputs.server_type }}" == "production" ]; then
          echo "üåê Website: https://boksitsupport.ch"
          echo "üìä Monitoring: https://monitoring.boksitsupport.ch"
        else
          echo "üñ•Ô∏è  VMware VM: 192.168.42.133"
          echo "üìä Lokale Services verf√ºgbar"
        fi
    
    - name: Notify on Failure
      if: failure()
      run: |
        echo "‚ùå BIT Origin Deployment fehlgeschlagen!"
        echo "üîç Bitte GitHub Actions Logs pr√ºfen"
        echo "‚ÑπÔ∏è  F√ºr lokale VMware-VM: Pr√ºfe SSH-Verbindung und Secrets"
    
    - name: Check Secrets
      if: always()
      run: |
        if [ -z "${{ secrets.SSH_PRIVATE_KEY }}" ] || [ -z "${{ secrets.SERVER_USER }}" ] || [ -z "${{ secrets.SERVER_HOST }}" ]; then
          echo "‚ö†Ô∏è  Deployment √ºbersprungen: Secrets nicht konfiguriert"
          echo "‚ÑπÔ∏è  F√ºr lokale VMware-VM ist automatisches Deployment nicht erforderlich"
          echo "‚ÑπÔ∏è  Manuelles Deployment: ssh user@192.168.42.133 'cd /opt/bit-origin && git pull'"
        else
          echo "‚úÖ Secrets konfiguriert - Deployment kann durchgef√ºhrt werden"
        fi
      continue-on-error: true






