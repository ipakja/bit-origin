name: BIT Origin Deployment

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup SSH
      uses: webfactory/ssh-agent@v0.7.0
      with:
        ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
    
    - name: Deploy to BIT Origin Server
      run: |
        ssh -o StrictHostKeyChecking=no ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} '
          set -e
          cd /opt/bit-origin || exit 1
          echo "ğŸ”„ Git Pull..."
          git pull origin main || exit 1
          
          echo "ğŸ”„ Docker Compose Update..."
          if [ -f docker/docker-compose.yml ]; then
            cd docker
            docker compose pull || true
            docker compose up -d || true
            cd ..
          fi
          
          echo "âœ… Deployment abgeschlossen"
        '
      continue-on-error: true
    
    - name: Health Check
      if: always()
      run: |
        echo "ğŸ” Health Checks..."
        FAILED=0
        
        if curl -f -s --max-time 5 https://boksitsupport.ch > /dev/null 2>&1; then
          echo "âœ… Website: OK"
        else
          echo "âš ï¸  Website: Nicht erreichbar"
          FAILED=1
        fi
        
        if curl -f -s --max-time 5 https://api.boksitsupport.ch/status > /dev/null 2>&1; then
          echo "âœ… API: OK"
        else
          echo "âš ï¸  API: Nicht erreichbar (optional)"
        fi
        
        if curl -f -s --max-time 5 https://monitoring.boksitsupport.ch > /dev/null 2>&1; then
          echo "âœ… Monitoring: OK"
        else
          echo "âš ï¸  Monitoring: Nicht erreichbar (optional)"
        fi
        
        if [ $FAILED -eq 1 ]; then
          echo "âš ï¸  Einige Health Checks fehlgeschlagen, aber Deployment fortgesetzt"
        fi
      continue-on-error: true
    
    - name: Notify on Success
      if: success()
      run: |
        echo "âœ… BIT Origin Deployment erfolgreich!"
        echo "ğŸŒ Website: https://boksitsupport.ch"
        echo "ğŸ“Š Monitoring: https://monitoring.boksitsupport.ch"
    
    - name: Notify on Failure
      if: failure()
      run: |
        echo "âŒ BIT Origin Deployment fehlgeschlagen!"
        echo "ğŸ” Bitte GitHub Actions Logs prÃ¼fen"






